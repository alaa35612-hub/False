// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © OpenAI

//@version=5
indicator(title = "ICT OTE (NY Session)", overlay = true, max_bars_back = 5000, max_lines_count = 100, max_boxes_count = 50, max_labels_count = 200)

// =============== Inputs
input_group_pivot = "Swing Detection"
leftBars = input.int(3, "Pivot Left Bars", minval = 1, group = input_group_pivot)
rightBars = input.int(3, "Pivot Right Bars", minval = 1, group = input_group_pivot)

input_group_levels = "OTE Levels"
showLevel062 = input.bool(true, "Show 0.62", group = input_group_levels)
showLevel0705 = input.bool(true, "Show 0.705 (Sweet Spot)", group = input_group_levels)
showLevel079 = input.bool(true, "Show 0.79", group = input_group_levels)

input_group_zone = "OTE Zone"
showZone = input.bool(true, "Show Zone (0.62 - 0.79)", group = input_group_zone)
zoneColor = input.color(color.new(color.teal, 85), "Zone Color", group = input_group_zone)

input_group_session = "NY Session"
nySession = input.session("0830-1100", "NY Window", group = input_group_session)

input_group_signals = "Signals"
entryMode = input.string("Touch0705", "Entry Trigger", options = ["Touch0705", "EnterZone"], group = input_group_signals)
cancelMode = input.string("CloseBeyond", "Invalidation", options = ["CloseBeyond", "WickBeyond"], group = input_group_signals)
requirePdSweep = input.bool(true, "Require PDH/PDL Sweep Before Swing", group = input_group_signals, tooltip = "If true, the swing end must occur after price has traded beyond the previous day's high/low.")

input_group_inst = "Institutional Numbers"
instThreshold = input.float(5.0, "Proximity (ticks/points)", minval = 0.0, group = input_group_inst)

input_group_targets = "Targets & Stops"
showTargets = input.bool(true, "Show Targets", group = input_group_targets)
showStops = input.bool(true, "Show Stop Loss", group = input_group_targets)
stopBuffer = input.float(10.0, "Stop Buffer (points/pips)", minval = 0.0, group = input_group_targets)
showBreakeven = input.bool(true, "Show Move SL to BE after TP1", group = input_group_targets)
roundTargets = input.bool(true, "Round Targets to Nearest 10 Level", group = input_group_targets)
minTp1Points = input.float(0.0, "Min TP1 Distance (points)", minval = 0.0, group = input_group_targets)

input_group_pd = "Previous Day Range"
showPrevDay = input.bool(true, "Show PDH/PDL", group = input_group_pd)

// =============== Helpers
inNySession = not na(time(timeframe.period, nySession, "America/New_York"))

prevDayHigh = request.security(syminfo.tickerid, "D", high[1], lookahead = barmerge.lookahead_on)
prevDayLow = request.security(syminfo.tickerid, "D", low[1], lookahead = barmerge.lookahead_on)

pivotHigh = ta.pivothigh(high, leftBars, rightBars)
pivotLow = ta.pivotlow(low, leftBars, rightBars)

var float lastPivotHigh = na
var int lastPivotHighIndex = na
var float lastPivotLow = na
var int lastPivotLowIndex = na

var float swingStart = na
var int swingStartIndex = na
var float swingEnd = na
var int swingEndIndex = na
var int swingDir = 0
var int lastPdHighSweepIndex = na
var int lastPdLowSweepIndex = na

if high > prevDayHigh
    lastPdHighSweepIndex := bar_index
if low < prevDayLow
    lastPdLowSweepIndex := bar_index

if not na(pivotHigh)
    int pivotIndex = bar_index - rightBars
    lastPivotHigh := pivotHigh
    lastPivotHighIndex := pivotIndex
    if not na(lastPivotLow) and lastPivotLowIndex < pivotIndex
        swingDir := 1
        swingStart := lastPivotLow
        swingStartIndex := lastPivotLowIndex
        swingEnd := pivotHigh
        swingEndIndex := pivotIndex

if not na(pivotLow)
    int pivotIndex = bar_index - rightBars
    lastPivotLow := pivotLow
    lastPivotLowIndex := pivotIndex
    if not na(lastPivotHigh) and lastPivotHighIndex < pivotIndex
        swingDir := -1
        swingStart := lastPivotHigh
        swingStartIndex := lastPivotHighIndex
        swingEnd := pivotLow
        swingEndIndex := pivotIndex

bool hasSwing = swingDir != 0 and not na(swingStart) and not na(swingEnd)
bool sweepOk = not requirePdSweep or (swingDir == 1 ? (not na(lastPdHighSweepIndex) and lastPdHighSweepIndex >= swingStartIndex and lastPdHighSweepIndex <= swingEndIndex) : (not na(lastPdLowSweepIndex) and lastPdLowSweepIndex >= swingStartIndex and lastPdLowSweepIndex <= swingEndIndex))
bool swingReady = hasSwing and sweepOk
float swingRange = swingReady ? math.abs(swingEnd - swingStart) : na

float fib062 = na
float fib0705 = na
float fib079 = na
float rawTarget1 = na
float rawTarget2 = na
float target1 = na
float target2 = na
float stopLevel = na

if swingReady
    if swingDir == 1
        fib062 := swingEnd - swingRange * 0.62
        fib0705 := swingEnd - swingRange * 0.705
        fib079 := swingEnd - swingRange * 0.79
        rawTarget1 := swingEnd + swingRange * 0.5
        rawTarget2 := swingEnd + swingRange * 1.0
        stopLevel := swingStart - stopBuffer
    if swingDir == -1
        fib062 := swingEnd + swingRange * 0.62
        fib0705 := swingEnd + swingRange * 0.705
        fib079 := swingEnd + swingRange * 0.79
        rawTarget1 := swingEnd - swingRange * 0.5
        rawTarget2 := swingEnd - swingRange * 1.0
        stopLevel := swingStart + stopBuffer

if swingReady
    target1 := roundTargets ? (swingDir == 1 ? math.floor(rawTarget1 / 10.0) * 10.0 : math.ceil(rawTarget1 / 10.0) * 10.0) : rawTarget1
    target2 := roundTargets ? (swingDir == 1 ? math.floor(rawTarget2 / 10.0) * 10.0 : math.ceil(rawTarget2 / 10.0) * 10.0) : rawTarget2

// =============== Institutional numbers (00, 20, 50, 80)
tickIndex = math.round(close / syminfo.mintick)
instDigits = tickIndex % 100
instDistance = math.min(math.abs(instDigits - 0), math.min(math.abs(instDigits - 20), math.min(math.abs(instDigits - 50), math.abs(instDigits - 80))))
instConfluence = instDistance <= instThreshold

// =============== Signals
zoneUpper = swingReady ? math.max(fib062, fib079) : na
zoneLower = swingReady ? math.min(fib062, fib079) : na
zoneTouched = swingReady and low <= zoneUpper and high >= zoneLower
sweetTouched = swingReady and low <= fib0705 and high >= fib0705

bullZone = swingReady and swingDir == 1 and zoneTouched
bearZone = swingReady and swingDir == -1 and zoneTouched

bullEntry = swingReady and swingDir == 1 and inNySession and ((entryMode == "Touch0705" and sweetTouched) or (entryMode == "EnterZone" and zoneTouched))
bearEntry = swingReady and swingDir == -1 and inNySession and ((entryMode == "Touch0705" and sweetTouched) or (entryMode == "EnterZone" and zoneTouched))

bullInvalid = swingReady and swingDir == 1 and ((cancelMode == "CloseBeyond" and close < fib079) or (cancelMode == "WickBeyond" and low < fib079))
bearInvalid = swingReady and swingDir == -1 and ((cancelMode == "CloseBeyond" and close > fib079) or (cancelMode == "WickBeyond" and high > fib079))
tp1Valid = swingReady and (minTp1Points <= 0.0 or math.abs(target1 - fib0705) >= minTp1Points)

// =============== Drawing (single updated objects)
var line line062 = na
var line line0705 = na
var line line079 = na
var box zoneBox = na
var label sweetLabel = na
var label swingLabel = na
var line tp1Line = na
var line tp2Line = na
var line slLine = na
var line pdhLine = na
var line pdlLine = na

if barstate.islast
    if showPrevDay
        if na(pdhLine)
            pdhLine := line.new(bar_index - 1, prevDayHigh, bar_index, prevDayHigh, extend = extend.right, color = color.new(color.gray, 30), style = line.style_dotted)
        else
            line.set_xy1(pdhLine, bar_index - 1, prevDayHigh)
            line.set_xy2(pdhLine, bar_index, prevDayHigh)
        if na(pdlLine)
            pdlLine := line.new(bar_index - 1, prevDayLow, bar_index, prevDayLow, extend = extend.right, color = color.new(color.gray, 30), style = line.style_dotted)
        else
            line.set_xy1(pdlLine, bar_index - 1, prevDayLow)
            line.set_xy2(pdlLine, bar_index, prevDayLow)
    else
        if not na(pdhLine)
            line.delete(pdhLine)
            pdhLine := na
        if not na(pdlLine)
            line.delete(pdlLine)
            pdlLine := na

    if swingReady
        if showLevel062
            if na(line062)
                line062 := line.new(bar_index - 1, fib062, bar_index, fib062, extend = extend.right, color = color.new(color.teal, 0))
            else
                line.set_xy1(line062, bar_index - 1, fib062)
                line.set_xy2(line062, bar_index, fib062)
        else if not na(line062)
            line.delete(line062)
            line062 := na

        if showLevel0705
            if na(line0705)
                line0705 := line.new(bar_index - 1, fib0705, bar_index, fib0705, extend = extend.right, color = color.new(color.yellow, 0), width = 2)
            else
                line.set_xy1(line0705, bar_index - 1, fib0705)
                line.set_xy2(line0705, bar_index, fib0705)
        else if not na(line0705)
            line.delete(line0705)
            line0705 := na

        if showLevel079
            if na(line079)
                line079 := line.new(bar_index - 1, fib079, bar_index, fib079, extend = extend.right, color = color.new(color.orange, 0))
            else
                line.set_xy1(line079, bar_index - 1, fib079)
                line.set_xy2(line079, bar_index, fib079)
        else if not na(line079)
            line.delete(line079)
            line079 := na

        if showZone
            if na(zoneBox)
                zoneBox := box.new(left = bar_index - 1, top = math.max(fib062, fib079), right = bar_index, bottom = math.min(fib062, fib079), bgcolor = zoneColor, border_color = color.new(color.teal, 40))
            else
                box.set_left(zoneBox, bar_index - 1)
                box.set_right(zoneBox, bar_index)
                box.set_top(zoneBox, math.max(fib062, fib079))
                box.set_bottom(zoneBox, math.min(fib062, fib079))
        else if not na(zoneBox)
            box.delete(zoneBox)
            zoneBox := na

        if showLevel0705
            if na(sweetLabel)
                sweetLabel := label.new(bar_index, fib0705, "OTE Sweet Spot", style = label.style_label_left, color = color.new(color.yellow, 0), textcolor = color.black)
            else
                label.set_xy(sweetLabel, bar_index, fib0705)
        else if not na(sweetLabel)
            label.delete(sweetLabel)
            sweetLabel := na

        if na(swingLabel)
            swingLabel := label.new(bar_index, close, swingDir == 1 ? "Bullish Swing" : "Bearish Swing", style = label.style_label_left, color = color.new(color.blue, 0), textcolor = color.white)
        else
            label.set_text(swingLabel, swingDir == 1 ? "Bullish Swing" : "Bearish Swing")
            label.set_xy(swingLabel, bar_index, close)

        if showTargets
            if na(tp1Line)
                tp1Line := line.new(bar_index - 1, target1, bar_index, target1, extend = extend.right, color = color.new(color.green, 0), style = line.style_dashed)
            else
                line.set_xy1(tp1Line, bar_index - 1, target1)
                line.set_xy2(tp1Line, bar_index, target1)
            if not tp1Valid
                line.set_color(tp1Line, color.new(color.green, 70))
            else
                line.set_color(tp1Line, color.new(color.green, 0))

            if na(tp2Line)
                tp2Line := line.new(bar_index - 1, target2, bar_index, target2, extend = extend.right, color = color.new(color.green, 20), style = line.style_dashed)
            else
                line.set_xy1(tp2Line, bar_index - 1, target2)
                line.set_xy2(tp2Line, bar_index, target2)
        else
            if not na(tp1Line)
                line.delete(tp1Line)
                tp1Line := na
            if not na(tp2Line)
                line.delete(tp2Line)
                tp2Line := na

        if showStops
            if na(slLine)
                slLine := line.new(bar_index - 1, stopLevel, bar_index, stopLevel, extend = extend.right, color = color.new(color.red, 0), style = line.style_dotted)
            else
                line.set_xy1(slLine, bar_index - 1, stopLevel)
                line.set_xy2(slLine, bar_index, stopLevel)
        else if not na(slLine)
            line.delete(slLine)
            slLine := na
    else
        if not na(line062)
            line.delete(line062)
            line062 := na
        if not na(line0705)
            line.delete(line0705)
            line0705 := na
        if not na(line079)
            line.delete(line079)
            line079 := na
        if not na(zoneBox)
            box.delete(zoneBox)
            zoneBox := na
        if not na(sweetLabel)
            label.delete(sweetLabel)
            sweetLabel := na
        if not na(swingLabel)
            label.delete(swingLabel)
            swingLabel := na
        if not na(tp1Line)
            line.delete(tp1Line)
            tp1Line := na
        if not na(tp2Line)
            line.delete(tp2Line)
            tp2Line := na
        if not na(slLine)
            line.delete(slLine)
            slLine := na

// =============== Labels & alerts
plotshape(bullEntry, title = "Bullish Entry", style = shape.labelup, text = "BUY", color = color.new(color.green, 0), textcolor = color.white, location = location.belowbar, size = size.tiny)
plotshape(bearEntry, title = "Bearish Entry", style = shape.labeldown, text = "SELL", color = color.new(color.red, 0), textcolor = color.white, location = location.abovebar, size = size.tiny)

plotshape(instConfluence, title = "Institutional Confluence", style = shape.circle, color = color.new(color.purple, 0), size = size.tiny, location = location.abovebar)

var int lastSwingKey = na
var bool breakevenShown = false
int swingKey = swingReady ? (swingStartIndex * 100000 + swingEndIndex) : na
if swingKey != lastSwingKey
    breakevenShown := false
    lastSwingKey := swingKey

if showBreakeven and showTargets and tp1Valid and not breakevenShown
    bool tp1Hit = swingDir == 1 ? high >= target1 : low <= target1
    if tp1Hit
        label.new(bar_index, target1, "Move SL to Breakeven", style = label.style_label_up, color = color.new(color.green, 0), textcolor = color.white)
        breakevenShown := true

// Alerts
alertcondition(inNySession and (bullZone or bearZone), title = "Entered OTE Zone", message = "Price entered OTE zone within NY window")
alertcondition(inNySession and (bullEntry or bearEntry), title = "Touch 0.705 / OTE Entry", message = "Price interacted with OTE sweet spot within NY window")
alertcondition(instConfluence, title = "Institutional Confluence", message = "Price near institutional number (00/20/50/80)")
alertcondition(tp1Valid and (swingDir == 1 ? high >= target1 : low <= target1), title = "Target 1 Hit", message = "OTE Target 1 reached")
alertcondition(swingReady and (swingDir == 1 ? high >= target2 : low <= target2), title = "Target 2 Hit", message = "OTE Target 2 reached")
alertcondition(bullInvalid or bearInvalid, title = "OTE Invalidated", message = "OTE model invalidated (0.79 broken)")

// =============== Info
var label infoLabel = na
if barstate.islast
    string dirText = swingDir == 1 ? "Bullish" : swingDir == -1 ? "Bearish" : "N/A"
    string sweepText = requirePdSweep ? (sweepOk ? "PD Sweep: Yes" : "PD Sweep: No") : "PD Sweep: Off"
    string infoText = "Current Swing: " + dirText + "\nNY Window: " + (inNySession ? "Active" : "Inactive") + "\n" + sweepText
    if na(infoLabel)
        infoLabel := label.new(bar_index, close, infoText, style = label.style_label_left, color = color.new(color.gray, 10), textcolor = color.white)
    else
        label.set_text(infoLabel, infoText)
        label.set_xy(infoLabel, bar_index, close)
