//@version=5
indicator("ICT Model 2022 Simple (5m/1m)", "ICT 2022 Simple", overlay=true, max_bars_back=5000, max_boxes_count=200, max_lines_count=200, max_labels_count=200)

// --------------------------- Inputs ---------------------------
htf_timeframe = input.timeframe("5", "HTF Timeframe")
show_sl_tp = input.bool(true, "Show Entry/SL/TP")
rr_ratio = input.float(2.0, "Risk/Reward", step=0.5, minval=0.5)

ltf_lookback = input.int(5, "LTF Swing Lookback", minval=1)
ltf_lookforward = input.int(3, "LTF Swing Lookforward", minval=1)
htf_lookback = input.int(10, "HTF Swing Lookback", minval=2)
htf_lookforward = input.int(10, "HTF Swing Lookforward", minval=1)

bull_fvg_color = input.color(color.new(color.green, 80), "Bullish FVG Color")
bear_fvg_color = input.color(color.new(color.red, 80), "Bearish FVG Color")
mitigated_fvg_color = input.color(color.new(color.gray, 85), "Mitigated FVG Color")

show_dashboard = input.bool(true, "Show Dashboard")

// --------------------------- Helpers ---------------------------
f_get_swing_high(_lookback, _lookforward) =>
    pivot = high[_lookforward]
    is_pivot = pivot > ta.highest(high, _lookback)[_lookforward + 1] and pivot > ta.highest(high, _lookforward)
    is_pivot ? pivot : na

f_get_swing_low(_lookback, _lookforward) =>
    pivot = low[_lookforward]
    is_pivot = pivot < ta.lowest(low, _lookback)[_lookforward + 1] and pivot < ta.lowest(low, _lookforward)
    is_pivot ? pivot : na

f_is_bullish_fvg() =>
    high[2] < low

f_is_bearish_fvg() =>
    low[2] > high

f_draw_risk_levels(_entry, _stop, _take) =>
    line.new(bar_index, _entry, bar_index + 50, _entry, color=color.new(color.blue, 0), style=line.style_dashed)
    line.new(bar_index, _stop, bar_index + 50, _stop, color=color.new(color.red, 0))
    line.new(bar_index, _take, bar_index + 50, _take, color=color.new(color.green, 0))

// --------------------------- Swing Points ---------------------------
ltf_swing_high = f_get_swing_high(ltf_lookback, ltf_lookforward)
ltf_swing_low = f_get_swing_low(ltf_lookback, ltf_lookforward)

[htf_swing_high, htf_swing_low] = request.security(
    syminfo.tickerid,
    htf_timeframe,
    [f_get_swing_high(htf_lookback, htf_lookforward), f_get_swing_low(htf_lookback, htf_lookforward)],
    lookahead=barmerge.lookahead_on
)

// --------------------------- Liquidity Levels ---------------------------
var float bsl_level = na
var float ssl_level = na

if not na(htf_swing_high)
    bsl_level := htf_swing_high

if not na(htf_swing_low)
    ssl_level := htf_swing_low

bool is_bsl_sweep = not na(bsl_level) and high > bsl_level and close < bsl_level
bool is_ssl_sweep = not na(ssl_level) and low < ssl_level and close > ssl_level

// --------------------------- State Machine ---------------------------
var bool waiting_for_bullish_mss = false
var bool waiting_for_bearish_mss = false
var float bullish_mss_level = na
var float bearish_mss_level = na
var bool bullish_mss_ready = false
var bool bearish_mss_ready = false

if is_ssl_sweep
    waiting_for_bullish_mss := true
    waiting_for_bearish_mss := false
    bullish_mss_level := ta.valuewhen(not na(ltf_swing_high), ltf_swing_high, 0)

if is_bsl_sweep
    waiting_for_bearish_mss := true
    waiting_for_bullish_mss := false
    bearish_mss_level := ta.valuewhen(not na(ltf_swing_low), ltf_swing_low, 0)

bool is_bullish_mss = waiting_for_bullish_mss and not na(bullish_mss_level) and close > bullish_mss_level
bool is_bearish_mss = waiting_for_bearish_mss and not na(bearish_mss_level) and close < bearish_mss_level

if is_bullish_mss
    waiting_for_bullish_mss := false
    bullish_mss_ready := true

if is_bearish_mss
    waiting_for_bearish_mss := false
    bearish_mss_ready := true

// --------------------------- FVG Detection ---------------------------
var box bullish_fvg_box = na
var box bearish_fvg_box = na

bool is_bullish_fvg = bullish_mss_ready and f_is_bullish_fvg()
bool is_bearish_fvg = bearish_mss_ready and f_is_bearish_fvg()

if is_bullish_fvg
    bullish_fvg_box := box.new(bar_index[2], high[2], bar_index, low, border_color=na, bgcolor=bull_fvg_color, extend=extend.right)
    label.new(bar_index, low, "Bullish ICT Setup", style=label.style_label_up, color=color.new(color.green, 20), textcolor=color.white)
    bullish_mss_ready := false

if is_bearish_fvg
    bearish_fvg_box := box.new(bar_index[2], high, bar_index, low[2], border_color=na, bgcolor=bear_fvg_color, extend=extend.right)
    label.new(bar_index, high, "Bearish ICT Setup", style=label.style_label_down, color=color.new(color.red, 20), textcolor=color.white)
    bearish_mss_ready := false

// Mitigation coloring
if not na(bullish_fvg_box)
    if low <= box.get_top(bullish_fvg_box) and high >= box.get_bottom(bullish_fvg_box)
        box.set_bgcolor(bullish_fvg_box, mitigated_fvg_color)

if not na(bearish_fvg_box)
    if low <= box.get_top(bearish_fvg_box) and high >= box.get_bottom(bearish_fvg_box)
        box.set_bgcolor(bearish_fvg_box, mitigated_fvg_color)

// --------------------------- Risk Levels ---------------------------
if show_sl_tp and is_bullish_fvg
    entry_price = high[2]
    stop_loss_price = ta.lowest(low, 10)
    take_profit_price = entry_price + (entry_price - stop_loss_price) * rr_ratio
    f_draw_risk_levels(entry_price, stop_loss_price, take_profit_price)

if show_sl_tp and is_bearish_fvg
    entry_price = low[2]
    stop_loss_price = ta.highest(high, 10)
    take_profit_price = entry_price - (stop_loss_price - entry_price) * rr_ratio
    f_draw_risk_levels(entry_price, stop_loss_price, take_profit_price)

// --------------------------- Dashboard ---------------------------
if show_dashboard
    var table dashboard = table.new(position.top_right, 1, 1, bgcolor=color.new(color.black, 60), border_width=1)
    string status_text = "Status: Monitoring Liquidity"
    if waiting_for_bullish_mss
        status_text := "Status: SSL Sweep\nWaiting for Bullish MSS"
    else if waiting_for_bearish_mss
        status_text := "Status: BSL Sweep\nWaiting for Bearish MSS"
    table.cell(dashboard, 0, 0, status_text, text_color=color.white)

// --------------------------- Preflight Checks ---------------------------
ltf_ok = timeframe.isminutes and timeframe.multiplier == 1
if barstate.islast and not ltf_ok
    label.new(bar_index, high, "Preflight: Switch chart to 1m for LTF logic.", style=label.style_label_down, color=color.new(color.orange, 10), textcolor=color.black)

if barstate.islast and htf_timeframe == timeframe.period
    label.new(bar_index, high, "Preflight: HTF should differ from chart timeframe.", style=label.style_label_down, color=color.new(color.orange, 10), textcolor=color.black)
